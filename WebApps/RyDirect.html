<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RyDirect - 高级网页跳转生成器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- 全局与基础样式 --- */
        :root {
            --font-main: 'Segoe UI', 'Roboto', sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
            --transition-speed: 0.3s;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            color: var(--text-primary);
            background-color: var(--bg-color);
            background-image: url('background.jpg'); /* 在这里替换你的背景图 */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-overlay);
            z-index: -1;
            transition: background-color var(--transition-speed) ease;
        }

        main {
            width: 100%;
            max-width: 800px;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            backdrop-filter: var(--card-backdrop-filter);
            -webkit-backdrop-filter: var(--card-backdrop-filter);
            transition: all var(--transition-speed) ease;
        }

        .hidden { display: none !important; }

        /* --- 主题切换 --- */
        .theme-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .theme-button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid var(--btn-border-color);
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border-radius: var(--btn-border-radius);
            transition: all var(--transition-speed) ease;
        }
        
        .theme-button.active {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-color: var(--btn-primary-bg);
        }

        /* --- 组件样式 --- */
        h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: var(--text-header);
        }
        p { margin-bottom: 1.5em; line-height: 1.6; }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .input, select {
            width: 100%;
            padding: 12px;
            border-radius: var(--input-border-radius);
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-focus-shadow);
        }

        .options-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .options-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .button {
            display: inline-block;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--btn-primary-text);
            background-color: var(--btn-primary-bg);
            border: none;
            border-radius: var(--btn-border-radius);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--btn-shadow);
            margin-right: 10px;
        }
        .button:hover {
            background-color: var(--btn-primary-hover-bg);
            box-shadow: var(--btn-hover-shadow);
            transform: translateY(-2px);
        }

        .result-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border-color);
            border-radius: var(--input-border-radius);
            word-wrap: break-word;
            font-family: var(--font-mono);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--input-border-color);
            margin-bottom: 1.5rem;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Overlap the container border */
        }
        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #redirect-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            z-index: 9999;
        }
        #redirect-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background-color: #333;
            color: white;
            border-radius: 25px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 10000;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        
        /* --- THEMES --- */

        /* 1. Material Design 1 */
        body.theme-material {
            --bg-color: #ECEFF1;
            --bg-overlay: rgba(255, 255, 255, 0);
            --card-bg: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-header: #000000;
            --accent-color: #2196F3;
            --accent-focus-shadow: rgba(33, 150, 243, 0.3);
            --card-border-radius: 4px;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 2px 10px rgba(0,0,0,0.08);
            --card-border: 1px solid #e0e0e0;
            --card-backdrop-filter: none;
            --input-bg: #F5F5F5;
            --input-border-color: #BDBDBD;
            --input-border-radius: 4px;
            --btn-bg: #f5f5f5;
            --btn-text: #333;
            --btn-border-color: #ccc;
            --btn-border-radius: 4px;
            --btn-primary-bg: #2196F3;
            --btn-primary-text: #FFFFFF;
            --btn-primary-hover-bg: #1976D2;
            --btn-shadow: 0 1px 3px rgba(0,0,0,0.2);
            --btn-hover-shadow: 0 2px 5px rgba(0,0,0,0.3);
            --font-main: 'Roboto', sans-serif;
        }

        /* 2. WinUI 2 (UWP) */
        body.theme-winui {
            --bg-color: #1a1a1a;
            --bg-overlay: rgba(0, 0, 0, 0.3);
            --card-bg: rgba(40, 40, 40, 0.8);
            --text-primary: #FFFFFF;
            --text-secondary: #c7c7c7;
            --text-header: #FFFFFF;
            --accent-color: #0078D4;
            --accent-focus-shadow: rgba(0, 120, 212, 0.4);
            --card-border-radius: 8px;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.4);
            --card-border: 1px solid rgba(255, 255, 255, 0.1);
            --card-backdrop-filter: blur(20px);
            --input-bg: rgba(0, 0, 0, 0.2);
            --input-border-color: rgba(255, 255, 255, 0.2);
            --input-border-radius: 4px;
            --btn-bg: rgba(255, 255, 255, 0.1);
            --btn-text: #FFF;
            --btn-border-color: rgba(255, 255, 255, 0.2);
            --btn-border-radius: 4px;
            --btn-primary-bg: #0078D4;
            --btn-primary-text: #FFFFFF;
            --btn-primary-hover-bg: #106EBE;
            --btn-shadow: none;
            --btn-hover-shadow: none;
            --font-main: 'Segoe UI', sans-serif;
        }

        /* 3. Metro */
        body.theme-metro {
            --bg-color: #1e1e1e;
            --bg-overlay: rgba(0, 0, 0, 0);
            --card-bg: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-header: #00AADD;
            --accent-color: #00AADD;
            --accent-focus-shadow: rgba(0, 170, 221, 0.4);
            --card-border-radius: 0;
            --card-shadow: none;
            --card-border: 2px solid var(--accent-color);
            --card-backdrop-filter: none;
            --input-bg: #3c3c3c;
            --input-border-color: #555;
            --input-border-radius: 0;
            --btn-bg: #444;
            --btn-text: #fff;
            --btn-border-color: #666;
            --btn-border-radius: 0;
            --btn-primary-bg: #00AADD;
            --btn-primary-text: #ffffff;
            --btn-primary-hover-bg: #008CBB;
            --btn-shadow: none;
            --btn-hover-shadow: none;
            --font-main: 'Segoe UI', sans-serif;
        }
        body.theme-metro h1 { text-align: left; font-weight: 300; }
        body.theme-metro .button:hover { transform: none; }


        /* 4. Liquid Glass */
        body.theme-liquid-glass {
            --bg-color: #6a85b6; /* Fallback */
            --bg-overlay: rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-header: #ffffff;
            --accent-color: #89f7fe;
            --accent-focus-shadow: rgba(137, 247, 254, 0.5);
            --card-border-radius: 16px;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --card-border: 1px solid rgba(255, 255, 255, 0.25);
            --card-backdrop-filter: blur(12px) saturate(180%);
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-border-color: rgba(255, 255, 255, 0.3);
            --input-border-radius: 8px;
            --btn-bg: rgba(255, 255, 255, 0.15);
            --btn-text: #fff;
            --btn-border-color: rgba(255, 255, 255, 0.3);
            --btn-border-radius: 8px;
            --btn-primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --btn-primary-text: #ffffff;
            --btn-primary-hover-bg: linear-gradient(135deg, #5a6fd5 0%, #68428e 100%);
            --btn-shadow: 0 2px 10px rgba(0,0,0,0.2);
            --btn-hover-shadow: 0 4px 15px rgba(0,0,0,0.3);
            --font-main: 'Segoe UI', sans-serif;
        }
        body.theme-liquid-glass {
            background-image: url('background.jpg'), linear-gradient(to right, #6a85b6, #bac8e0);
        }

    </style>
</head>
<body class="theme-winui">

    <div id="app-container">
        <main>
            <header>
                <h1>Rydirect</h1>
                <p>一个高级网页跳转工具，支持多种编码、凯撒移位、以及将代码藏入文件。</p>
            </header>
            
            <section class="theme-switcher">
                <button class="theme-button" data-theme="material">Material Design</button>
                <button class="theme-button active" data-theme="winui">WinUI 2</button>
                <button class="theme-button" data-theme="metro">Metro</button>
                <button class="theme-button" data-theme="liquid-glass">Liquid Glass</button>
            </section>

            <div class="tabs">
                <button class="tab active" data-tab="generator">生成器</button>
                <button class="tab" data-tab="steganography">文件隐写</button>
            </div>

            <div id="generator" class="tab-content active">
                <div class="form-group">
                    <label for="targetUrl">目标网址 (URL)</label>
                    <input type="url" id="targetUrl" class="input" placeholder="https://example.com" value="https://www.bilibili.com">
                </div>
                
                <div class="form-group">
                    <label for="caesarPlace">凯撒移位位数</label>
                    <input type="number" id="caesarPlace" class="input" value="13" min="1">
                </div>

                <div class="form-group">
                    <label for="caesarCode">编码格式</label>
                    <select id="caesarCode" class="input">
                        <option value="5">UTF-8 (推荐)</option>
                        <option value="1">ASCII</option>
                        <option value="2">GBK</option>
                        <option value="3">GB2312</option>
                        <option value="4">Unicode (UCS-2)</option>
                    </select>
                </div>

                <div class="form-group options-group">
                    <div>
                        <label>Base64 是否倒转</label>
                        <label><input type="radio" name="reverse" value="2" checked> 否</label>
                        <label><input type="radio" name="reverse" value="1"> 是</label>
                    </div>
                    <div>
                        <label>是否隐形跳转</label>
                        <label><input type="radio" name="hiddenRedirect" value="n" checked> 否</label>
                        <label><input type="radio" name="hiddenRedirect" value="y"> 是</label>
                    </div>
                </div>

                <button id="generateBtn" class="button">生成链接</button>

                <div id="resultContainer" class="hidden">
                    <h3>生成结果:</h3>
                    <div id="resultUrl" class="result-box"></div>
                    <button id="copyBtn" class="button" style="margin-top: 1rem;">复制链接</button>
                </div>
            </div>

            <div id="steganography" class="tab-content">
                <section>
                    <h4>1. 将代码写入文件</h4>
                    <div class="form-group">
                        <label for="embedCode">要写入的 RyDirectCode (可从生成器自动填入)</label>
                        <input type="text" id="embedCode" class="input" placeholder="将上方生成的链接中的 RyDirectCode 粘贴于此">
                    </div>
                    <div class="form-group">
                        <label for="fileToEmbed">选择一个文件 (图片、文档等)</label>
                        <input type="file" id="fileToEmbed" class="input">
                    </div>
                    <button id="embedBtn" class="button">写入并下载</button>
                </section>
                <hr style="margin: 2rem 0; border: 1px solid var(--input-border-color);">
                <section>
                    <h4>2. 从文件中解析代码</h4>
                    <div class="form-group">
                        <label for="fileToExtract">选择含有 RyDirectCode 的文件</label>
                        <input type="file" id="fileToExtract" class="input">
                    </div>
                    <button id="extractBtn" class="button">开始解析</button>
                    <div id="extractedResultContainer" class="hidden">
                        <h3>解析出的完整链接:</h3>
                        <div id="extractedUrl" class="result-box"></div>
                         <button id="copyExtractedBtn" class="button" style="margin-top: 1rem;">复制链接</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="redirect-overlay" class="hidden">
        <iframe id="redirect-iframe" src="about:blank"></iframe>
    </div>

    <div id="notification" class="notification"></div>
    
    <noscript>
        <p style="color:white; text-align:center; font-size: 1.5rem;">此页面需要 JavaScript 才能正常工作。</p>
    </noscript>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 全局变量和元素引用 ---
    const appContainer = document.getElementById('app-container');
    const redirectOverlay = document.getElementById('redirect-overlay');
    const redirectIframe = document.getElementById('redirect-iframe');
    const notification = document.getElementById('notification');
    
    const ENCODING_MAP = {
        '1': 'windows-1252', // Closest browser-supported to ASCII
        '2': 'gbk',
        '3': 'gb2312',
        '4': 'utf-16le', // UCS-2 in LE
        '5': 'utf-8'
    };

    const STEG_MARKER_START = '//--RYDIRECT_DATA_START--//';
    const STEG_MARKER_END = '//--RYDIRECT_DATA_END--//';

    // --- 核心加解密逻辑 ---
    
    // 凯撒移位 (作用于字符编码 code point)
    function caesarShift(codes, shift) {
        return codes.map(code => code + shift);
    }

    // 编码过程
    async function encode(url, shift, encodingKey, reverse) {
        try {
            const encoder = new TextEncoder(ENCODING_MAP[encodingKey]);
            const encodedBytes = encoder.encode(url);
            
            // 将字节数组转为 code point 数组 (这里我们直接对字节值移位)
            const codePoints = Array.from(encodedBytes);
            const shiftedCodePoints = caesarShift(codePoints, shift);
            
            // 将移位后的 code point 数组转回 Uint8Array
            const shiftedBytes = new Uint8Array(shiftedCodePoints);
            
            // 将字节流转为 Base64
            // btoa 不支持 Unicode，所以需要一个辅助函数
            const base64String = btoa(String.fromCharCode.apply(null, shiftedBytes));

            return reverse === '1' ? base64String.split('').reverse().join('') : base64String;
        } catch (e) {
            console.error("Encoding error:", e);
            showNotification(`编码失败: ${e.message}`, 'error');
            return null;
        }
    }

    // 解码过程
    async function decode(ryDirectCode, shift, encodingKey, reverse) {
        try {
            let base64String = reverse === '1' ? ryDirectCode.split('').reverse().join('') : ryDirectCode;
            const binaryString = atob(base64String);
            
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            const codePoints = Array.from(bytes);
            const unshiftedCodePoints = caesarShift(codePoints, -shift);
            
            const unshiftedBytes = new Uint8Array(unshiftedCodePoints);

            const decoder = new TextDecoder(ENCODING_MAP[encodingKey]);
            return decoder.decode(unshiftedBytes);
        } catch (e) {
            console.error("Decoding error:", e);
            showNotification(`解码失败: ${e.message}`, 'error');
            return null;
        }
    }

    // --- 页面加载时的重定向处理 ---
    async function handleRedirectOnLoad() {
        const params = new URLSearchParams(window.location.search);
        const ryDirectCode = params.get('RyDirectCode');
        const caesarPlace = params.get('CaesarPlace');
        const caesarCode = params.get('CaesarCode');
        const reverse = params.get('Reverse');
        const hiddenRedirect = params.get('HiddenRedirect');

        if (ryDirectCode && caesarPlace && caesarCode && reverse && hiddenRedirect) {
            appContainer.classList.add('hidden');
            document.title = "正在跳转...";
            
            const shift = parseInt(caesarPlace, 10);
            
            const decodedUrl = await decode(ryDirectCode, shift, caesarCode, reverse);

            if (decodedUrl) {
                if (hiddenRedirect === 'y') {
                    redirectIframe.src = decodedUrl;
                    redirectOverlay.classList.remove('hidden');
                } else {
                    window.location.href = decodedUrl;
                }
            } else {
                appContainer.classList.remove('hidden');
                document.title = "RyRedirect - 解码失败";
                showNotification("解码失败，请检查链接参数是否正确。", "error");
            }
        }
    }

    // --- UI 事件处理 ---
    
    // 生成链接
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.addEventListener('click', async () => {
        const targetUrl = document.getElementById('targetUrl').value;
        const caesarPlace = parseInt(document.getElementById('caesarPlace').value, 10);
        const caesarCode = document.getElementById('caesarCode').value;
        const reverse = document.querySelector('input[name="reverse"]:checked').value;
        const hiddenRedirect = document.querySelector('input[name="hiddenRedirect"]:checked').value;

        if (!targetUrl || isNaN(caesarPlace)) {
            showNotification("请填写所有必填项。", "error");
            return;
        }

        const ryDirectCode = await encode(targetUrl, caesarPlace, caesarCode, reverse);

        if (ryDirectCode) {
            const baseUrl = window.location.origin + window.location.pathname;
            const finalUrl = `${baseUrl}?RyDirectCode=${encodeURIComponent(ryDirectCode)}&CaesarPlace=${caesarPlace}&CaesarCode=${caesarCode}&Reverse=${reverse}&HiddenRedirect=${hiddenRedirect}`;
            
            document.getElementById('resultUrl').textContent = finalUrl;
            document.getElementById('resultContainer').classList.remove('hidden');
            
            // 自动填充到隐写术输入框
            document.getElementById('embedCode').value = ryDirectCode;
        }
    });

    // 复制链接
    const copyBtn = document.getElementById('copyBtn');
    copyBtn.addEventListener('click', () => {
        const urlToCopy = document.getElementById('resultUrl').textContent;
        navigator.clipboard.writeText(urlToCopy).then(() => {
            showNotification("链接已复制到剪贴板！");
        }, () => {
            showNotification("复制失败！", "error");
        });
    });

    const copyExtractedBtn = document.getElementById('copyExtractedBtn');
    copyExtractedBtn.addEventListener('click', () => {
        const urlToCopy = document.getElementById('extractedUrl').textContent;
        navigator.clipboard.writeText(urlToCopy).then(() => {
            showNotification("链接已复制到剪贴板！");
        }, () => {
            showNotification("复制失败！", "error");
        });
    });

    // 主题切换
    const themeButtons = document.querySelectorAll('.theme-button');
    themeButtons.forEach(button => {
        button.addEventListener('click', () => {
            const theme = button.dataset.theme;
            document.body.className = `theme-${theme}`;
            themeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        });
    });
    
    // Tab 切换
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(item => item.classList.remove('active'));
            tab.classList.add('active');
            const target = document.getElementById(tab.dataset.tab);
            tabContents.forEach(content => content.classList.remove('active'));
            target.classList.add('active');
        });
    });
    
    // --- 文件隐写术 (Steganography) 逻辑 ---

    const embedBtn = document.getElementById('embedBtn');
    embedBtn.addEventListener('click', async () => {
        const ryDirectCode = document.getElementById('embedCode').value;
        const fileInput = document.getElementById('fileToEmbed');

        if (!ryDirectCode || fileInput.files.length === 0) {
            showNotification("请提供 RyDirectCode 和一个文件。", "error");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            const fileContent = new Uint8Array(e.target.result);
            
            // 准备要嵌入的数据
            const params = new URLSearchParams(document.getElementById('resultUrl').textContent.split('?')[1]);
            const payload = {
                RyDirectCode: ryDirectCode,
                CaesarPlace: params.get('CaesarPlace'),
                CaesarCode: params.get('CaesarCode'),
                Reverse: params.get('Reverse'),
                HiddenRedirect: params.get('HiddenRedirect')
            };
            const payloadString = JSON.stringify(payload);
            const payloadData = `${STEG_MARKER_START}${payloadString}${STEG_MARKER_END}`;
            
            const textEncoder = new TextEncoder();
            const payloadBytes = textEncoder.encode(payloadData);

            // 合并文件和数据
            const newFileBytes = new Uint8Array(fileContent.length + payloadBytes.length);
            newFileBytes.set(fileContent, 0);
            newFileBytes.set(payloadBytes, fileContent.length);

            const blob = new Blob([newFileBytes], { type: file.type });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `embedded_${file.name}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification("数据已写入，文件开始下载。");
        };

        reader.readAsArrayBuffer(file);
    });

    const extractBtn = document.getElementById('extractBtn');
    extractBtn.addEventListener('click', () => {
        const fileInput = document.getElementById('fileToExtract');
        if (fileInput.files.length === 0) {
            showNotification("请选择一个文件进行解析。", "error");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            const fileContent = e.target.result;
            const startIndex = fileContent.indexOf(STEG_MARKER_START);
            const endIndex = fileContent.indexOf(STEG_MARKER_END);

            if (startIndex !== -1 && endIndex !== -1) {
                const payloadString = fileContent.substring(startIndex + STEG_MARKER_START.length, endIndex);
                try {
                    const payload = JSON.parse(payloadString);
                    const baseUrl = window.location.origin + window.location.pathname;
                    const finalUrl = `${baseUrl}?RyDirectCode=${encodeURIComponent(payload.RyDirectCode)}&CaesarPlace=${payload.CaesarPlace}&CaesarCode=${payload.CaesarCode}&Reverse=${payload.Reverse}&HiddenRedirect=${payload.HiddenRedirect}`;
                    
                    document.getElementById('extractedUrl').textContent = finalUrl;
                    document.getElementById('extractedResultContainer').classList.remove('hidden');
                    showNotification("成功解析出数据！");
                } catch (err) {
                    showNotification("解析数据失败：数据格式错误。", "error");
                }
            } else {
                showNotification("未在文件中找到 RyDirectCode 数据。", "error");
                document.getElementById('extractedResultContainer').classList.add('hidden');
            }
        };

        reader.readAsText(file, 'utf-8'); // Read as text to find string markers
    });


    // --- 辅助函数 ---
    
    // 显示通知
    let notificationTimeout;
    function showNotification(message, type = 'success') {
        notification.textContent = message;
        notification.style.backgroundColor = type === 'error' ? '#D32F2F' : '#333';
        notification.classList.add('show');
        
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // --- 初始化 ---
    handleRedirectOnLoad();
});
</script>

</body>
</html>
